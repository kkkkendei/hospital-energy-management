{"ast":null,"code":"import \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport { mapState } from 'vuex';\nimport axios from 'axios';\nexport default {\n  name: 'UserDashboard',\n  data() {\n    return {\n      deviceStats: [],\n      threshold: 100,\n      // 每台设备报警阈值 100kWh\n      timer: null\n    };\n  },\n  computed: {\n    ...mapState('auth', ['currentUser']),\n    isAdmin() {\n      return this.currentUser && this.currentUser.enabled === true;\n    },\n    alarmDevices() {\n      return this.deviceStats.filter(device => device.averageEnergyConsumedPerRecord > this.threshold);\n    }\n  },\n  methods: {\n    fetchDeviceStats() {\n      // 获取近30天的用电设备能耗数据\n      const now = new Date();\n      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n      start.setDate(start.getDate() - 29); // 包含今天共30天\n      axios.get('/api/energy-stats', {\n        params: {\n          startTime: start.toISOString().slice(0, 19),\n          endTime: now.toISOString().slice(0, 19),\n          timeGranularityForTrend: 'daily',\n          energyType: 'kWh' // 只查用电\n        }\n      }).then(res => {\n        if (res.data && res.data.deviceBreakdown) {\n          this.deviceStats = res.data.deviceBreakdown;\n        }\n      }).catch(() => {\n        this.$message.error('获取设备能耗数据失败');\n      });\n    },\n    tableRowClassName({\n      row\n    }) {\n      return row.averageEnergyConsumedPerRecord > this.threshold ? 'alarm-row' : '';\n    }\n  },\n  mounted() {\n    if (this.isAdmin) {\n      this.fetchDeviceStats();\n      this.timer = setInterval(this.fetchDeviceStats, 30000); // 每30秒刷新一次\n    }\n  },\n  beforeDestroy() {\n    if (this.timer) {\n      clearInterval(this.timer);\n    }\n  }\n};","map":{"version":3,"names":["mapState","axios","name","data","deviceStats","threshold","timer","computed","isAdmin","currentUser","enabled","alarmDevices","filter","device","averageEnergyConsumedPerRecord","methods","fetchDeviceStats","now","Date","start","getFullYear","getMonth","getDate","setDate","get","params","startTime","toISOString","slice","endTime","timeGranularityForTrend","energyType","then","res","deviceBreakdown","catch","$message","error","tableRowClassName","row","mounted","setInterval","beforeDestroy","clearInterval"],"sources":["src/views/Dashboard.vue"],"sourcesContent":["<template>\r\n  <div>\r\n    <el-card>\r\n      <div slot=\"header\">\r\n        <span>欢迎回来, {{ currentUser ? currentUser.username : '未知用户' }}!</span>\r\n      </div>\r\n      <p>这里是医院能源管理系统仪表盘。</p>\r\n      <p>当前用户：{{ currentUser ? currentUser.username : '未知用户' }} ({{ currentUser && currentUser.enabled ? '管理员' : '普通用户' }})</p>\r\n      <div v-if=\"isAdmin\">\r\n        <div v-if=\"alarmDevices.length > 0\" style=\"margin-bottom: 20px;\">\r\n          <el-alert\r\n            v-for=\"device in alarmDevices\"\r\n            :key=\"device.deviceId\"\r\n            :title=\"`警报：设备【${device.deviceName}】今日能耗已达 ${device.totalEnergyConsumed} kWh，超出阈值！`\"\r\n            type=\"error\"\r\n            show-icon\r\n            :closable=\"false\"\r\n            style=\"margin-bottom: 8px;\"\r\n          />\r\n        </div>\r\n        <el-table :data=\"deviceStats\" style=\"width: 100%; margin-top: 20px;\" :row-class-name=\"tableRowClassName\">\r\n          <el-table-column prop=\"deviceName\" label=\"设备名称\" width=\"180\" />\r\n          <el-table-column prop=\"totalEnergyConsumed\" label=\"总能耗 (kWh)\" width=\"180\" />\r\n          <el-table-column prop=\"unit\" label=\"单位\" width=\"100\" />\r\n          <el-table-column prop=\"averageEnergyConsumedPerRecord\" label=\"平均能耗 (kWh)\" width=\"180\" />\r\n          <el-table-column prop=\"numberOfRecords\" label=\"数据条数\" width=\"120\" />\r\n          <el-table-column label=\"状态\" width=\"120\">\r\n            <template slot-scope=\"scope\">\r\n              <el-tag v-if=\"scope.row.totalEnergyConsumed > threshold\" type=\"danger\">能耗超标</el-tag>\r\n              <el-tag v-else type=\"success\">正常</el-tag>\r\n            </template>\r\n          </el-table-column>\r\n        </el-table>\r\n      </div>\r\n    </el-card>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapState } from 'vuex';\r\nimport axios from 'axios';\r\n\r\nexport default {\r\n  name: 'UserDashboard',\r\n  data() {\r\n    return {\r\n      deviceStats: [],\r\n      threshold: 100, // 每台设备报警阈值 100kWh\r\n      timer: null\r\n    };\r\n  },\r\n  computed: {\r\n    ...mapState('auth', ['currentUser']),\r\n    isAdmin() {\r\n      return this.currentUser && this.currentUser.enabled === true;\r\n    },\r\n    alarmDevices() {\r\n      return this.deviceStats.filter(device => device.averageEnergyConsumedPerRecord > this.threshold);\r\n    }\r\n  },\r\n  methods: {\r\n    fetchDeviceStats() {\r\n      // 获取近30天的用电设备能耗数据\r\n      const now = new Date();\r\n      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());\r\n      start.setDate(start.getDate() - 29); // 包含今天共30天\r\n      axios.get('/api/energy-stats', {\r\n        params: {\r\n          startTime: start.toISOString().slice(0, 19),\r\n          endTime: now.toISOString().slice(0, 19),\r\n          timeGranularityForTrend: 'daily',\r\n          energyType: 'kWh' // 只查用电\r\n        }\r\n      }).then(res => {\r\n        if (res.data && res.data.deviceBreakdown) {\r\n          this.deviceStats = res.data.deviceBreakdown;\r\n        }\r\n      }).catch(() => {\r\n        this.$message.error('获取设备能耗数据失败');\r\n      });\r\n    },\r\n    tableRowClassName({ row }) {\r\n      return row.averageEnergyConsumedPerRecord > this.threshold ? 'alarm-row' : '';\r\n    }\r\n  },\r\n  mounted() {\r\n    if (this.isAdmin) {\r\n      this.fetchDeviceStats();\r\n      this.timer = setInterval(this.fetchDeviceStats, 30000); // 每30秒刷新一次\r\n    }\r\n  },\r\n  beforeDestroy() {\r\n    if (this.timer) {\r\n      clearInterval(this.timer);\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.el-card {\r\n  margin: 20px;\r\n}\r\n\r\np {\r\n  margin: 10px 0;\r\n  font-size: 16px;\r\n  line-height: 1.5;\r\n}\r\n\r\n.alarm-row {\r\n  background: #ffeaea !important;\r\n}\r\n</style> "],"mappings":";;AAuCA,SAAAA,QAAA;AACA,OAAAC,KAAA;AAEA;EACAC,IAAA;EACAC,KAAA;IACA;MACAC,WAAA;MACAC,SAAA;MAAA;MACAC,KAAA;IACA;EACA;EACAC,QAAA;IACA,GAAAP,QAAA;IACAQ,QAAA;MACA,YAAAC,WAAA,SAAAA,WAAA,CAAAC,OAAA;IACA;IACAC,aAAA;MACA,YAAAP,WAAA,CAAAQ,MAAA,CAAAC,MAAA,IAAAA,MAAA,CAAAC,8BAAA,QAAAT,SAAA;IACA;EACA;EACAU,OAAA;IACAC,iBAAA;MACA;MACA,MAAAC,GAAA,OAAAC,IAAA;MACA,MAAAC,KAAA,OAAAD,IAAA,CAAAD,GAAA,CAAAG,WAAA,IAAAH,GAAA,CAAAI,QAAA,IAAAJ,GAAA,CAAAK,OAAA;MACAH,KAAA,CAAAI,OAAA,CAAAJ,KAAA,CAAAG,OAAA;MACArB,KAAA,CAAAuB,GAAA;QACAC,MAAA;UACAC,SAAA,EAAAP,KAAA,CAAAQ,WAAA,GAAAC,KAAA;UACAC,OAAA,EAAAZ,GAAA,CAAAU,WAAA,GAAAC,KAAA;UACAE,uBAAA;UACAC,UAAA;QACA;MACA,GAAAC,IAAA,CAAAC,GAAA;QACA,IAAAA,GAAA,CAAA9B,IAAA,IAAA8B,GAAA,CAAA9B,IAAA,CAAA+B,eAAA;UACA,KAAA9B,WAAA,GAAA6B,GAAA,CAAA9B,IAAA,CAAA+B,eAAA;QACA;MACA,GAAAC,KAAA;QACA,KAAAC,QAAA,CAAAC,KAAA;MACA;IACA;IACAC,kBAAA;MAAAC;IAAA;MACA,OAAAA,GAAA,CAAAzB,8BAAA,QAAAT,SAAA;IACA;EACA;EACAmC,QAAA;IACA,SAAAhC,OAAA;MACA,KAAAQ,gBAAA;MACA,KAAAV,KAAA,GAAAmC,WAAA,MAAAzB,gBAAA;IACA;EACA;EACA0B,cAAA;IACA,SAAApC,KAAA;MACAqC,aAAA,MAAArC,KAAA;IACA;EACA;AACA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}